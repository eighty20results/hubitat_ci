name: Release Publish

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      MAVEN_GROUP_ID: me.${{ github.repository_owner }}.hubitat_ci
      MAVEN_ARTIFACT_ID: hubitat_ci
      MAVEN_ENDPOINT: https://maven.pkg.github.com/${{ github.repository_owner }}/hubitat_ci
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: gradle

      - name: Derive version from tag
        id: version
        run: |
          set -e
          set -o pipefail
          
          TAG="${GITHUB_REF_NAME:-${{ github.event.release.tag_name }}}"
          TAG_NO_V=${TAG#v}
          if [[ ! "$TAG_NO_V" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag must be semver (X.Y.Z) optionally prefixed with v; got '$TAG'" >&2
            exit 1
          fi
          # Set VERSION env var first so gradlew can use it
          export VERSION="$TAG_NO_V"
          
          # Run gradlew and capture output with error handling
          if ! GRADLE_OUTPUT=$(./gradlew properties -q 2>&1); then
            echo "Error: gradlew properties command failed" >&2
            echo "$GRADLE_OUTPUT" >&2
            exit 1
          fi
          
          # Extract version and validate it's not empty
          FILE_VERSION=$(echo "$GRADLE_OUTPUT" | awk -F': ' '/^version:/ {print $2; exit}')
          if [[ -z "$FILE_VERSION" ]]; then
            echo "Error: Could not extract version from gradlew properties output" >&2
            exit 1
          fi
          
          # Validate version matches tag
          if [[ "$FILE_VERSION" != "$TAG_NO_V" ]]; then
            echo "Tag version ($TAG_NO_V) does not match build.gradle version ($FILE_VERSION)" >&2
            exit 1
          fi
          echo "version=$TAG_NO_V" >> $GITHUB_OUTPUT
          echo "VERSION=$TAG_NO_V" >> $GITHUB_ENV

      - name: Verify submodule fixtures
        run: |
          set -euo pipefail
          missing=()
          paths=(
            "SubmodulesWithScripts/EcoNet/Hubitat/SmartApps/econet-tankless-app.groovy"
            "SubmodulesWithScripts/EcoNet/Hubitat/SmartApps/econet-thermostat-app.groovy"
            "SubmodulesWithScripts/Hubitat/Drivers/fibaro-double-switch-2-fgs-223.src/fibaro-double-switch-2-fgs-223.groovy"
            "SubmodulesWithScripts/homeremote/hubitatapp"
            "SubmodulesWithScripts/homebridge-hubitat-tonesto7/smartapps/tonesto7/homebridge-hubitat.src/homebridge-hubitat.groovy"
            "SubmodulesWithScripts/Hubitat_iComfort/App/Lennox-iComfort-connect.groovy"
            "SubmodulesWithScripts/konnected/hubitat/apps/konnected-connect.groovy"
            "SubmodulesWithScripts/influxdb_logger/influxdb-logger.groovy"
          )
          for p in "${paths[@]}"; do
            if [[ ! -e "$p" ]]; then
              missing+=("$p")
            fi
          done
          if (( ${#missing[@]} > 0 )); then
            echo "Missing required submodule fixtures:" >&2
            printf ' - %s\n' "${missing[@]}" >&2
            echo "Ensure submodules are fetched (git submodule update --init --recursive)." >&2
            exit 1
          fi

      - name: Build and test
        run: ./gradlew clean test --no-daemon --stacktrace

      - name: Publish to GitHub Packages
        env:
          REPO_USERNAME: ${{ github.actor }}
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./gradlew publish --no-daemon --stacktrace

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hubitat_ci-artifacts
          path: |
            build/libs/hubitat_ci*.jar
            build/libs/*-sources.jar
            build/libs/*-groovydoc.jar

      - name: Upload test reports on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            build/test-results/test
            build/reports/tests/test

